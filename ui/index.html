<!DOCTYPE html>
<meta charset="utf-8">
<link rel="stylesheet" href="/common.css"></link>
<style>

.cell {
	position: relative;
	margin: 40px 0;
}

.cellContent {
	overflow: auto;
	padding-left: 2.5em;
}

.cell::before, .cell::after {
	position: absolute;
	height: 10px;
	right: 0;
	left: 0;
	content: '';
}

.cell::before {
	bottom: 100%;
	background: linear-gradient(rgba(0, 0, 0, 0), rgba(0, 0, 0, 0.15));
}

.cell::after {
	top: 100%;
	background: linear-gradient(rgba(0, 0, 0, 0.15), rgba(0, 0, 0, 0));
}

.meta {
	background: #eee;
	margin-left: -2.5em;
	padding-left: 2.5em;
}

.command {
	margin: 0.5em 0;
}

.commandStatus::before {
	position: absolute;
	width: 2.25em;
	margin-left: -2.5em;
	text-align: right;
	color: rgba(0, 0, 0, 0.7);
}

.commandStatus.ready::before {
	content: '$';
}

.commandStatus.running::before {
	content: 'â€¦';
}

.commandStatus.exited::before {
	content: attr(data-exit-status);
}

.commandInput {
	border: none;
	font: inherit;
	box-sizing: border-box;
	padding: 0;
	margin: 0;
	width: 100%;
	outline: none;
}

.stdout, .stderr, .messageout {
	margin: 0.25em 0;
	padding-left: .5em;
	margin-left: -.5em;
	white-space: pre-wrap;
}

.stdout {
	border-left: 0.2em solid rgba(0, 0, 0, 0.5);
}

.stderr {
	border-left: 0.2em solid rgba(255, 0, 0, 0.5);
}

.messageout {
	border-left: 0.2em solid rgba(0, 255, 0, 0.5);
}

.ui {
	border: none;
	width: 100%;
}

</style>
<div id=shell></div>
<script src="/common.js"></script>
<script>
var Views = {
	Command: function() {
		function Command() {
			this.el = document.createElement('div');
			this.el.classList.add('command');
			this.els = {
				commandLine: document.createElement('div'),
				commandStatus: document.createElement('div'),
				commandForm: document.createElement('form'),
				commandInput: document.createElement('input')
			};
			this.els.commandLine.classList.add('commandLine');
			this.els.commandStatus.classList.add('commandStatus');
			this.els.commandStatus.classList.add('ready');
			this.els.commandInput.classList.add('commandInput');
			this.els.commandInput.spellcheck = false;
			this.els.commandInput.autocomplete = false;

			this.els.commandLine.appendChild(this.els.commandStatus);
			this.els.commandForm.appendChild(this.els.commandInput);
			this.els.commandLine.appendChild(this.els.commandForm);

			this.el.appendChild(this.els.commandLine);

			this.els.commandForm.addEventListener('submit', function(e) {
				e.preventDefault();
				if (this.onexecute) {
					this.onexecute(this);
				}
			}.bind(this));
		}
		Command.prototype.value = function() {
			return this.els.commandInput.value;
		}
		Command.prototype.select = function() {
			this.els.commandInput.focus();
		};
		Command.prototype.setRunning = function() {
			this.els.commandInput.disabled = true;
			this.els.commandStatus.classList.remove('ready');
			this.els.commandStatus.classList.add('running');
		};
		Command.prototype.exit = function(exitStatus) {
			this.els.commandStatus.classList.remove('ready');
			this.els.commandStatus.classList.add('exited');
			this.els.commandStatus.dataset.exitStatus = exitStatus;
		};
		Command.prototype.messageout = function(m) {
			if (!this.els.messageout) {
				this.els.messageout = document.createElement('div');
				this.els.messageout.classList.add('messageout');
				this.el.appendChild(this.els.messageout);
			}
			this.els.messageout.textContent += JSON.stringify(m);
			this.els.messageout.textContent += '\n';
		};
		Command.prototype.stdout = function(text) {
			if (!this.els.stdout) {
				this.els.stdout = document.createElement('div');
				this.els.stdout.classList.add('stdout');
				this.el.appendChild(this.els.stdout);
			}
			this.els.stdout.textContent += text;
		};
		Command.prototype.stderr = function(text) {
			if (!this.els.stderr) {
				this.els.stderr = document.createElement('div');
				this.els.stderr.classList.add('stderr');
				this.el.appendChild(this.els.stderr);
			}
			this.els.stderr.textContent += text;
		};
		Command.prototype.addUI = function(ui) {
			this.el.appendChild(ui.el);
		};
		return Command;
	}(),
	Cell: function() {
		function Cell() {
			this.el = document.createElement('div');
			this.el.classList.add('cell');
			this.els = {
				cellContent: document.createElement('div'),
			};
			this.els.cellContent.classList.add('cellContent');
			this.el.appendChild(this.els.cellContent);
		}
		Cell.prototype.meta = function(text) {
			var metaEl = document.createElement('div');
			metaEl.classList.add('meta');
			metaEl.textContent = text
			this.els.cellContent.appendChild(metaEl);
		};
		Cell.prototype.select = function() {
			if (this.currentCommand) {
				return;
			}
			this.currentCommand = new Views.Command(this);
			this.els.cellContent.appendChild(this.currentCommand.el);
			this.currentCommand.onexecute = function(command) {
				(new Task(command)).spawn(command.value(), function() {
					delete this.currentCommand;
					this.select();
				}.bind(this));
			}.bind(this);

			this.currentCommand.select();
		};
		return Cell;
	}(),
	UI: function() {
		function UIInterface(data, frame) {
			this.data = data;
			this.frame = frame;
		}

		UIInterface.prototype.resize = function(){
			this.frame.style.height = this.frame.contentWindow.getComputedStyle(this.frame.contentDocument.body).height;
		};

		function UI(data, path) {
			this.data = data;

			this.el = document.createElement('iframe');
			this.el.className = 'ui';
			this.el.shell = this.interface = new UIInterface(data, this.el);
			this.el.src = path;
		}
		UI.prototype.onmessage = function(m) {
			if (this.interface.onmessage) {
				this.interface.onmessage(m);
			}
		}
		return UI;
	}()
};

function DictionaryOutput() {
	this.dict = {};
}

DictionaryOutput.prototype.onmessage = util.dispatchMessage;

DictionaryOutput.prototype.msg_set = function(m) {
	var k;
	for (k in m) {
		this.dict[k] = m[k];
	}
};

DictionaryOutput.prototype.msg_delete = function(m) {
	m.forEach(function(k) {
		delete this.dict[k];
	}.bind(this));
};


function Task(view) {
	this.view = view;
}

Task.prototype.spawn = function(command, onexit) {
	this.view.setRunning();
	Shell.spawn(command, {
		exit: function(exitStatus){
			this.view.exit(exitStatus);
			onexit();
		}.bind(this),
		stdout: this.view.stdout.bind(this.view),
		stderr: this.view.stderr.bind(this.view),
		message: function(json) {
			this.onmessage(JSON.parse(json))
		}.bind(this)
	});
};

Task.prototype.onmessage = function(m) {
	// this.view.messageout(m);
	util.dispatchMessage.call(this, m);
};

Task.prototype.msg_checkin = function(m) {
	if ("output_type" in m) switch (m.output_type) {
	case "dictionary":
		this.output = new DictionaryOutput();
		this.outputView = new Views.UI(this.output, '/output/dictionary.html');
		this.view.addUI(this.outputView);
		break;
	default:
		throw new Error("Unknown output type: " + m.output_type);
	}
};

Task.prototype.msg_output = function(m) {
	if (!this.output) {
		throw new Error("Task sent output before checking in");
	}
	this.output.onmessage(m);
	if (this.outputView) {
		this.outputView.onmessage(m);
	}

};

var cli = {
	cells: [],

	newCell: function (){
		var cell = new Views.Cell();
		this.cells.push(cell);
		shell.appendChild(cell.el);
		cell.meta('~');
		cell.select();
	}
};

cli.newCell();

</script>
